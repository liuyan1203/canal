package com.haiziwang.commodity.task;

import com.haiziwang.commodity.common.CanalRow;
import com.haiziwang.commodity.strategy.table.TableStrategy;
import com.haiziwang.commodity.strategy.table.TableStrategyContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;

import java.util.concurrent.ArrayBlockingQueue;

public class ConsumerTask {

    private static final Logger logger = LoggerFactory.getLogger(ConsumerTask.class);

    private ArrayBlockingQueue<CanalRow> canalQueue = null;

    private Thread thread = null;

    protected volatile boolean running = false;
    protected Thread.UncaughtExceptionHandler handler = new Thread.UncaughtExceptionHandler() {

        public void uncaughtException(Thread t, Throwable e) {
            logger.error("canal consumer task has an error", e);
        }
    };

    public ConsumerTask(ArrayBlockingQueue<CanalRow> canalQueue) {
        this.canalQueue = canalQueue;
    }

    public void start() {
        thread = new Thread(() -> {
            process();
        });
        thread.setUncaughtExceptionHandler(handler);
        running = true;
        thread.start();
    }

    public void stop() {
        if (!running) {
            return;
        }
        running = false;
        if (thread != null) {
            try {
                thread.join();
            } catch (InterruptedException e) {
                // ignore
            }
        }

        MDC.remove("destination");
    }

    private void process() {
        while (running || canalQueue.size() > 0) {
            if (canalQueue.size() > 0) {
                try {
                    CanalRow canalRow = canalQueue.take();
                    //根据表名引用策略模式
                String tableName = canalRow.getTableName();
                TableStrategyContext tableStrategyContext = new TableStrategyContext(tableName);
                TableStrategy tableStrategy = tableStrategyContext.getTableStrategy();
                tableStrategy.execute(canalRow);
            } catch (Exception e) {
                logger.error("消费线程异常:");
                e.printStackTrace();
            }
            } else {
                try {
                    logger.debug("队列中没有消息，线程[{}]睡5秒...", Thread.currentThread().getName());
                    thread.sleep(5000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }


            }
        }

    }
}