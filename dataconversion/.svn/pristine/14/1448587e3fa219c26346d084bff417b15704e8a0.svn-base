package com.haiziwang.commodity.strategy.table;

import com.alibaba.otter.canal.protocol.CanalEntry;
import com.haiziwang.commodity.common.CanalRow;
import com.haiziwang.commodity.common.Constant;
import com.haiziwang.commodity.mapper.*;
import com.haiziwang.commodity.model.dto.SkuUpdateFlagDTO;
import com.haiziwang.commodity.model.po.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.*;

public class SkuStrategyImpl extends CommonStrategyImpl implements TableStrategy {

    private static final Logger logger = LoggerFactory.getLogger(SkuStrategyImpl.class);

    private static String NEW_SPU_ID_PREFIX = "sk";

    private static String SPU_ID_PREFIX = "sp";

    private static Map<String, Set<String>> conversionRelation = new HashMap<String, Set<String>>() {
        {
            put("sku", new HashSet<String>() {
                {
                    add("Fskulocalcode");
                    add("Fskucategoryattr");
                    add("Fskusaleattr");
                    add("Fskukeyattr");
                    add("Fskupacklist");
                    add("Fmainurl");
                    add("Fskuunitcost");
                    add("Fskureferprice");
                    add("Fskupurchprice");
                    add("Fskuceilprice");
                    add("Fskufloorprice");
                    add("Fskuproperty");
                    add("Fskuunit");
                    add("Fskuaddtime");
                    add("Fskulastupdatetime");
                    add("Fskulastdowntime");
                    add("Fskutitle");
                }
            });
            put("spu", new HashSet<String>() {
                {
                    add("Fspuid");
                    add("Fcooperatorid");
                    add("Fflagshipstoreid");
                    add("Fskushortname");
                    add("Fskusubtitle");
                    add("Fcategoryid");
                    add("Ftempid");
                    add("Ftoptempid");
                    add("Fbottomtempid");
                    add("Fskuproducingarea");
                    add("Fskusort");
                    add("Fskulastdowntime");
                    add("Fskulastuptime");
                    add("Fskutype");
                    add("Fskuspecmodel");
                }
            });
        }
    };

    @Override
    public int insert(CanalRow canalRow) {
        // 获取需要关注的字段
//        List<String> columns = getColumnsToChange(HzwSkuPO.class);
        /**
         * 执行转换的逻辑
         * 将canal中CanalEntry.Column转化为PO
         */
        HzwSkuPO skuPO = (HzwSkuPO) getPOByCanalRow(canalRow, new HzwSkuPO());
        logger.info("sku[{}]  eventType[{}] ", skuPO.toString(), canalRow.getEventType());
        handlerSkuInsert(skuPO);
        return 1;
    }

    @Override
    public int update(CanalRow canalRow) {
        // 获取关注的字段
        List<String> columns = getColumnsToChange(HzwSkuPO.class);
        // 获取更新的字段
        Map<String, String> updatedColumnsMap = getUpdatedColumns(canalRow, columns);
        // 判断是否需要进行字段转换
        if (!canalRow.getNeedChange())
            return 0;

        HzwSkuPO skuPO = (HzwSkuPO) getPOByCanalRow(canalRow, new HzwSkuPO());
        int index = 0;
        if (skuPO.getFspuid() == 0) {
            index = (int) (skuPO.getFskuid() % Constant.DB_SHARDING);
        } else {
            index = (int) (skuPO.getFspuid() % Constant.DB_SHARDING);
        }

        // 查询中间库是否存在sku
        ConversionSkuMapper conversionSkuMapper = context.getBean(ConversionSkuMapper.class);
        ConversionSkuPO conversionSkuPO = conversionSkuMapper.selectBySkuId(index, skuPO.getFskuid());
        if (conversionSkuPO != null) {
            //更新
            handlerSkuUpdate(skuPO, updatedColumnsMap, index, conversionSkuPO.getFspuid(), conversionSkuPO.getFid());
        } else {
            //新增
            handlerSkuInsert(skuPO);
        }

        /**
         * 执行转换的逻辑
         * 将canal中CanalEntry.Column转化为PO
         */

        logger.info("修改skuid=[{}]  sku[{}]", skuPO.getFskuid(), skuPO.toString());
        return 1;
    }

    @Override
    public int delete(CanalRow canalRow) {
        return 0;
    }

    @Override
    public int execute(CanalRow canalRow) {
        int recordNum = 0;
        if (canalRow.getEventType() == CanalEntry.EventType.INSERT) {
            recordNum = insert(canalRow);
        } else if (canalRow.getEventType() == CanalEntry.EventType.UPDATE) {
            recordNum = update(canalRow);
        } else if (canalRow.getEventType() == CanalEntry.EventType.DELETE) {
            recordNum = delete(canalRow);
        }
        return recordNum;
    }

    private void handlerSkuUpdate(HzwSkuPO skuPO, Map<String, String> updatedColumnsMap, int index, String spuId, Long skuFid) {
        SkuUpdateFlagDTO skuUpdateFlagDTO = new SkuUpdateFlagDTO();
        ConversionSpuPO conversionSpuPO = new ConversionSpuPO();
        ConversionSkuPO conversionSkuPO = new ConversionSkuPO();
        for (Map.Entry entry : updatedColumnsMap.entrySet()) {
            String columnName = (String) entry.getKey();
//            String columnvValue = (String) entry.getValue();
            switch (columnName) {
                case "Fskulocalcode":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskulocalcode(skuPO.getFskulocalcode());
                    break;
                case "Fskucategoryattr":
                    //直接映射t_sku.Fskucategoryattr
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFcategoryattr(skuPO.getFskucategoryattr());
                    break;
                case "Fskusaleattr":
                    //直接映射t_sku.Fskusaleattr
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskusaleattr(skuPO.getFskusaleattr());
                    break;
                case "Fskukeyattr":
                    //直接映射t_sku.Fskukeyattr
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskukeyattr(skuPO.getFskukeyattr());
                    break;
                case "Fskupacklist":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskupacklist(skuPO.getFskupacklist());
                    break;
                case "Fmainurl":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskumainurl(skuPO.getFmainurl());
                    break;
                case "Fskuunitcost":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuunitcost(skuPO.getFskuunitcost());
                    break;
                case "Fskureferprice":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuerpreferprice(skuPO.getFskureferprice());
                    break;
                case "Fskupurchprice":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuerppurchprice(skuPO.getFskupurchprice());
                    break;
                case "Fskuceilprice":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuerpceilingprice(skuPO.getFskuceilprice());
                    break;
                case "Fskuerpfloorprice":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuerpfloorprice(skuPO.getFskufloorprice());
                    break;
                case "Fskuproperty":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuproperty(skuPO.getFskuproperty());
                    break;
                case "Fskuunit":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskuunit(skuPO.getFskuunit());
                    break;
                case "Fskuaddtime":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskustockexpiretime(skuPO.getFskuaddtime());
                    break;
                case "Fskulastupdatetime":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskulastupdatetime(skuPO.getFskulastupdatetime());
                    break;
                case "Fskulastuptime":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSkuPO.setFskulastupstatetime(skuPO.getFskulastuptime());
                    break;
                /**
                 * spu
                 */
                case "Fflagshipstoreid":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFflagshipstoreid(skuPO.getFflagshipstoreid());
                    break;
                case "Fspushortname":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFspushortname(skuPO.getFskushortname());
                    break;
                case "Fskusubtitle":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFspusubtitle(skuPO.getFskusubtitle());
                    break;
                case "Fcategoryid":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFcategoryid(skuPO.getFcategoryid());
                    break;
                case "Ftempid":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFtempid(skuPO.getFtempid());
                    break;
                case "Ftoptempid":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFtoptempid(skuPO.getFtoptempid());
                    break;
                case "Fbottomtempid":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFbottomtempid(skuPO.getFbottomtempid());
                    break;
                case "Fskuproducingarea":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFspuproducingarea(skuPO.getFskuproducingarea());
                    break;
                case "Fskusort":
                    skuUpdateFlagDTO.check(columnName, conversionRelation);
                    conversionSpuPO.setFspusort(skuPO.getFskusort());
                    break;
                case "Fskutype":
                    // 如果是POP-SPU 取t_spu. Fsputype 否则 取t_sku. Fskutype
                    if (skuPO.getFcooperatorid() == 3 && skuPO.getFspuid() != 0) {
                        skuUpdateFlagDTO.check(columnName, conversionRelation);
                        conversionSpuPO.setFsputype(skuPO.getFskutype());
                    }
                    break;
                case "Fskuspecmodel":
                    if (skuPO.getFcooperatorid() == 3 && skuPO.getFspuid() != 0) {
                        skuUpdateFlagDTO.check(columnName, conversionRelation);
                        conversionSpuPO.setFspuspecmodel(skuPO.getFskuspecmodel());
                    }
                    break;
                default:
                    logger.info("没有处理的字段 [{}]", columnName);

            }
        }
        if (skuUpdateFlagDTO.getUpdateSpu()) {
            ConversionSpuMapper conversionSpuMapper = context.getBean(ConversionSpuMapper.class);
            ConversionSpuPO exsitSpu = conversionSpuMapper.selectBySpuId(index, spuId, null);
            if (exsitSpu != null) {
                conversionSpuPO.setFid(exsitSpu.getFid());
                conversionSpuMapper.updateByPrimaryKeySelective(index, conversionSpuPO);
            }
        }
        if (skuUpdateFlagDTO.getUpdateSku()) {
            ConversionSkuMapper conversionSkuMapper = context.getBean(ConversionSkuMapper.class);
            conversionSkuPO.setFid(skuFid);
            conversionSkuMapper.updateByPrimaryKeySelective(index, conversionSkuPO);
        }

    }

    public void handlerSkuInsert(HzwSkuPO skuPO) {
        // 孩子王库存在spu
        boolean hwzExsitSpu = false;
        boolean conversionExsitSpu = false;
        // 分表下标
        Integer index = 0;
        String spuId = "";
        ConversionSkuPO conversionSkuPO = new ConversionSkuPO();
        ConversionSpuPO conversionSpuPO = new ConversionSpuPO();

        // 处理spuid
        if (skuPO.getFspuid() == 0) {
            spuId = createSpuId(skuPO.getFskuid(), NEW_SPU_ID_PREFIX);
        } else {
            spuId = createSpuId(skuPO.getFspuid(), SPU_ID_PREFIX);
            hwzExsitSpu = true;
        }
        index = getTableIndex(spuId);
        // 判断中间库是否已经存在spu
        ConversionSpuMapper conversionSpuMapper = context.getBean(ConversionSpuMapper.class);
        ConversionSpuPO exsitConversionSpuPO = conversionSpuMapper.selectBySpuId(index, spuId, skuPO.getFcooperatorid());
        if (exsitConversionSpuPO != null) {
            conversionExsitSpu = true;
        }

        /**
         * sku赋值
         */
        conversionSkuPO.setFskuid(skuPO.getFskuid());
        conversionSkuPO.setFplatformid(0);
        conversionSkuPO.setFspuid(spuId);
        //暂不处理

        conversionSkuPO.setFskulocalcode(skuPO.getFskulocalcode());
        conversionSkuPO.setFskustate(skuPO.getFskustate());
        conversionSkuPO.setFcategoryattr(skuPO.getFskucategoryattr());
        conversionSkuPO.setFskusaleattr(skuPO.getFskusaleattr());
        conversionSkuPO.setFskukeyattr(skuPO.getFskukeyattr());
        conversionSkuPO.setFskupacklist(skuPO.getFskupacklist());
        conversionSkuPO.setFskumainurl(skuPO.getFmainurl());
        conversionSkuPO.setFskuunitcost(skuPO.getFskuunitcost());
        conversionSkuPO.setFskuerpreferprice(skuPO.getFskureferprice());
        conversionSkuPO.setFskuerppurchprice(skuPO.getFskupurchprice());
        conversionSkuPO.setFskuerpceilingprice(skuPO.getFskuceilprice());
        conversionSkuPO.setFskuerpfloorprice(skuPO.getFskufloorprice());
        conversionSkuPO.setFskuproperty(skuPO.getFskuproperty());
        conversionSkuPO.setFskuunit(skuPO.getFskuunit());
        conversionSkuPO.setFskustockexpiretime(skuPO.getFskustockexpiretime());
        conversionSkuPO.setFskulastupdatetime(skuPO.getFskulastupdatetime());
        conversionSkuPO.setFskulastupstatetime(skuPO.getFskulastuptime());
        conversionSkuPO.setFskulastdowntime(skuPO.getFskulastdowntime());

        /**
         * spu赋值
         */
        conversionSpuPO.setFspuid(spuId);
        conversionSpuPO.setFplatformid(0);
        conversionSpuPO.setFspuextcode("");
        conversionSpuPO.setFcooperatorid(skuPO.getFcooperatorid());
        conversionSpuPO.setFflagshipstoreid(skuPO.getFflagshipstoreid());

        conversionSpuPO.setFspushortname(skuPO.getFskushortname());
        conversionSpuPO.setFspusubtitle(skuPO.getFskusubtitle());

        conversionSpuPO.setFcategoryid(skuPO.getFcategoryid());
        conversionSpuPO.setFtempid(skuPO.getFtempid());
        conversionSpuPO.setFtoptempid(skuPO.getFtoptempid());
        conversionSpuPO.setFbottomtempid(skuPO.getFbottomtempid());
        conversionSpuPO.setFspuproducingarea(skuPO.getFskuproducingarea());
        conversionSpuPO.setFspusort(skuPO.getFskusort());
        conversionSpuPO.setFspulastdownstoretime(skuPO.getFskulastdowntime());
        conversionSpuPO.setFspulastupstoretime(skuPO.getFskulastuptime());
        conversionSpuPO.setFbrandid(skuPO.getFskubrand());

        // 如果是POP-SPU 取t_spu. Fsputype 否则 取t_sku. Fskutype
        conversionSpuPO.setFsputype(skuPO.getFskutype());
        conversionSpuPO.setFspuspecmodel(skuPO.getFskuspecmodel());

        // todo 待定
        conversionSpuPO.setFspustate(skuPO.getFskustate());
        conversionSpuPO.setFspuaddtime(new Date());
        conversionSpuPO.setFspulastupdatetime(new Date());
        conversionSpuPO.setFsputitle(skuPO.getFskutitle());
        conversionSpuPO.setFspucategoryattr(skuPO.getFskucategoryattr());
        conversionSpuPO.setFremark("");
        conversionSpuPO.setFcreateuser("");
        // 首次发布时间（取值待定）
        conversionSpuPO.setFspufirstpublishtime(null);

        //判断是否自营，查询sku_erp
        if (skuPO.getFcooperatorid() == 3) {
            //取值sku_erp(自营才有erp)
            HzwSkuErpMapper hzwSkuErpMapper = context.getBean(HzwSkuErpMapper.class);
            HzwSkuErpPO hzwSkuErpPO = hzwSkuErpMapper.getSkuById(skuPO.getFskuid());
            if (hzwSkuErpPO != null) {
                conversionSkuPO.setFgrossmargin(hzwSkuErpPO.getFgrossmargin());
                conversionSkuPO.setFgoodsno(hzwSkuErpPO.getFgoodsno());
                conversionSkuPO.setFskulevel(hzwSkuErpPO.getFlevel());

                conversionSpuPO.setFsputitle(hzwSkuErpPO.getFskutitle());
                conversionSpuPO.setFerpbrandid(hzwSkuErpPO.getFbrandid());
                conversionSpuPO.setFspuvatrate(hzwSkuErpPO.getFskuvatrate());
                conversionSpuPO.setFspupurchtaxrate(hzwSkuErpPO.getFskupurchtaxrate());
            }
        }
        //判断是否spu商品
        if (hwzExsitSpu) {
            HzwSpuMapper hzwSpuMapper = context.getBean(HzwSpuMapper.class);
            HzwSpuPO exsitHzwSpuPO = hzwSpuMapper.getSpuById(skuPO.getFspuid());
            if (exsitHzwSpuPO != null) {
                // todo 待确定
                conversionSpuPO.setFspustate(exsitHzwSpuPO.getFspustate());
                conversionSpuPO.setFspuaddtime(exsitHzwSpuPO.getFaddtime());
                conversionSpuPO.setFspulastupdatetime(exsitHzwSpuPO.getFlastupdatetime());
                conversionSpuPO.setFsputitle(exsitHzwSpuPO.getFsputitle());
                conversionSpuPO.setFspucategoryattr(exsitHzwSpuPO.getFspucategoryattr());

                conversionSpuPO.setFsputype(exsitHzwSpuPO.getFsputype());
                conversionSpuPO.setFspuspecmodel(exsitHzwSpuPO.getFspuspecmodel());
            }
            //取值spu_erp(自营才有erp)
            HzwSpuErpMapper hzwSpuErpMapper = context.getBean(HzwSpuErpMapper.class);
            HzwSpuErpPO exsitHzwSpuErpPO = hzwSpuErpMapper.getSpuById(skuPO.getFspuid());
            if (exsitHzwSpuErpPO != null) {
                conversionSpuPO.setFremark(exsitHzwSpuErpPO.getFremark());
                conversionSpuPO.setFcreateuser(exsitHzwSpuErpPO.getFcreateuser());
            }

        }
        if (conversionExsitSpu) {
            conversionSpuPO.setFid(exsitConversionSpuPO.getFid());
            conversionSpuMapper.updateByPrimaryKeySelective(index, conversionSpuPO);
            logger.info("conversionSpuPO更新成功! [{}]", conversionSpuPO.toString());
        } else {
            conversionSpuMapper.insertSelective(index, conversionSpuPO);
            logger.info("conversionSpuPO新增成功! [{}]", conversionSpuPO.toString());
        }
        ConversionSkuMapper conversionSkuMapper = context.getBean(ConversionSkuMapper.class);
        conversionSkuMapper.insertSelective(index, conversionSkuPO);
        logger.info("conversionSkuPO新增成功! [{}]", conversionSkuPO.toString());
    }


}